<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Energy Agent Dashboard (GR)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary: #10b981;
  --primary-dark: #059669;
  --bg-dark: #111827;
  --bg-gray: #1f2937;
  --bg-light: #f3f4f6;
  --card-bg: #ffffff;
  --text-dark: #111827;
  --text-gray: #6b7280;
  --border: #e5e7eb;
  --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background: var(--bg-light);
  color: var(--text-dark);
  font-size: 12px;
}

.app-container {
  display: flex;
  height: 100vh;
}

/* Sidebar */
.sidebar {
  width: 220px;
  background: var(--bg-dark);
  color: white;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-lg);
  z-index: 10;
}

.sidebar-header {
  padding: 16px 14px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.sidebar-header h1 {
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 2px;
}

.sidebar-header .version {
  font-size: 9px;
  color: var(--primary);
  font-weight: 500;
}

.sidebar-nav {
  flex: 1;
  padding: 12px 8px;
  overflow-y: auto;
}

.nav-button {
  width: 100%;
  background: transparent;
  color: rgba(255,255,255,0.7);
  border: none;
  padding: 8px 10px;
  margin-bottom: 4px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  transition: all 0.2s;
  text-align: left;
}

.nav-button:hover {
  background: var(--bg-gray);
  color: white;
}

.nav-button.active {
  background: var(--primary);
  color: white;
  font-weight: 600;
}

.nav-button i {
  width: 16px;
  text-align: center;
  font-size: 13px;
}

.sidebar-footer {
  padding: 12px 10px;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.ai-usage {
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.3);
  border-radius: 8px;
  padding: 8px;
  font-size: 10px;
}

.ai-usage-label {
  color: rgba(255,255,255,0.6);
  margin-bottom: 6px;
}

.ai-usage-bar {
  height: 6px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  overflow: hidden;
  margin: 8px 0;
}

.ai-usage-fill {
  height: 100%;
  background: var(--primary);
  transition: width 0.3s;
}

.ai-usage-text {
  color: white;
  font-weight: 600;
}

/* AI Search Toggle */
.ai-toggle-container {
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 8px;
  padding: 8px;
  font-size: 10px;
  margin-top: 8px;
}

.ai-toggle-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.ai-toggle-label {
  color: rgba(255,255,255,0.6);
  display: flex;
  align-items: center;
  gap: 6px;
}

.toggle-switch {
  position: relative;
  width: 44px;
  height: 24px;
  background: rgba(255,255,255,0.1);
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.3s;
}

.toggle-switch.active {
  background: #3b82f6;
}

.toggle-slider {
  position: absolute;
  top: 3px;
  left: 3px;
  width: 18px;
  height: 18px;
  background: white;
  border-radius: 50%;
  transition: transform 0.3s;
}

.toggle-switch.active .toggle-slider {
  transform: translateX(20px);
}

.ai-toggle-status {
  color: rgba(255,255,255,0.5);
  font-size: 10px;
  margin-top: 6px;
}

/* Main Content */
.main-content {
  flex: 1;
  overflow-y: auto;
  background: var(--bg-light);
}

.content-header {
  background: white;
  padding: 20px 32px;
  border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow);
  position: sticky;
  top: 0;
  z-index: 5;
}

.content-header h2 {
  font-size: 17px;
  font-weight: 700;
  margin-bottom: 4px;
}

.content-header p {
  color: var(--text-gray);
  font-size: 12px;
}

.content-body {
  padding: 24px 32px;
  max-width: 1400px;
}

/* Cards */
.card {
  background: var(--card-bg);
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 12px;
  box-shadow: var(--shadow);
  transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.card-title {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 6px;
  color: var(--text-dark);
}

.card-title a {
  color: var(--text-dark);
  text-decoration: none;
  transition: color 0.2s;
}

.card-title a:hover {
  color: var(--primary);
}

.card-meta {
  display: flex;
  align-items: center;
  gap: 16px;
  margin: 8px 0;
  font-size: 11px;
  color: var(--text-gray);
}

.card-meta i {
  margin-right: 4px;
}

.badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 10px;
  font-weight: 600;
  background: var(--primary);
  color: white;
}

.card-summary {
  margin-top: 12px;
  color: var(--text-gray);
  line-height: 1.6;
}

.card-actions {
  margin-top: 12px;
  display: flex;
  gap: 8px;
}

/* Forms */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--text-dark);
}

.form-input, .form-textarea {
  width: 100%;
  padding: 10px 14px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 13px;
  transition: border-color 0.2s;
  font-family: inherit;
}

.form-input:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--primary);
}

.form-textarea {
  resize: vertical;
  min-height: 120px;
}

/* Buttons */
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.btn-secondary {
  background: var(--bg-gray);
  color: white;
}

.btn-secondary:hover {
  background: #374151;
}

.btn-small {
  padding: 5px 10px;
  font-size: 11px;
}

.btn-icon {
  padding: 10px;
  width: 40px;
  height: 40px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

/* Loading */
.loading {
  text-align: center;
  padding: 40px;
  color: var(--text-gray);
}

.loading i {
  font-size: 26px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-gray);
}

.empty-state i {
  font-size: 38px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.empty-state h3 {
  font-size: 16px;
  margin-bottom: 8px;
  color: var(--text-dark);
}

/* Reply Box */
.reply-box {
  background: #f0fdf4;
  border: 2px solid var(--primary);
  border-radius: 12px;
  padding: 16px;
  margin-top: 16px;
}

.reply-box-label {
  font-weight: 600;
  color: var(--primary-dark);
  margin-bottom: 8px;
  display: block;
}

.reply-box-content {
  color: var(--text-dark);
  line-height: 1.6;
}

/* Search & Filter */
.toolbar {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.search-box {
  flex: 1;
  min-width: 250px;
  position: relative;
}

.search-box input {
  width: 100%;
  padding: 10px 14px 10px 38px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 13px;
}

.search-box i {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-gray);
}

.filter-group {
  display: flex;
  gap: 8px;
}

.filter-btn {
  padding: 8px 14px;
  background: white;
  border: 2px solid var(--border);
  border-radius: 10px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
}

.filter-btn:hover {
  border-color: var(--primary);
  color: var(--primary);
}

.filter-btn.active {
  background: var(--primary);
  border-color: var(--primary);
  color: white;
}

/* Responsive */
@media (max-width: 768px) {
  .sidebar {
    width: 240px;
  }

  .content-body {
    padding: 16px;
  }

  .toolbar {
    flex-direction: column;
  }
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: var(--shadow);
}

.stat-value {
  font-size: 26px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 4px;
}

.stat-label {
  font-size: 12px;
  color: var(--text-gray);
}

/* Source List */
.source-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px;
  background: var(--bg-light);
  border-radius: 8px;
  margin-bottom: 8px;
}

.source-info {
  flex: 1;
}

.source-url {
  font-weight: 600;
  color: var(--text-dark);
  margin-bottom: 4px;
}

.source-type {
  font-size: 10px;
  color: var(--text-gray);
}

/* Notes UI */
.notes-toolbar {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.notes-filters {
  display: flex;
  gap: 8px;
  flex: 1;
  flex-wrap: wrap;
}

.filter-select {
  padding: 7px 10px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: white;
  font-size: 12px;
  min-width: 150px;
}

.note-card {
  background: white;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: var(--shadow);
  transition: all 0.2s;
}

.note-card:hover {
  box-shadow: var(--shadow-lg);
}

.note-card.pinned {
  border-color: #fbbf24;
  background: #fffbeb;
}

.note-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.note-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-dark);
  flex: 1;
}

.note-actions {
  display: flex;
  gap: 8px;
}

.note-action-btn {
  background: transparent;
  border: none;
  color: var(--text-gray);
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all 0.2s;
}

.note-action-btn:hover {
  background: var(--bg-light);
  color: var(--primary);
}

.note-action-btn.pinned {
  color: #fbbf24;
}

.note-content {
  color: var(--text-gray);
  margin-bottom: 12px;
  line-height: 1.6;
  white-space: pre-wrap;
}

.note-meta {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  font-size: 10px;
  color: var(--text-gray);
}

.note-category {
  background: var(--primary);
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  font-weight: 500;
}

.note-tag {
  background: var(--bg-light);
  padding: 4px 10px;
  border-radius: 6px;
}

.note-date {
  margin-left: auto;
}

/* Note Editor Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  border-radius: 16px;
  padding: 24px;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-header h3 {
  font-size: 16px;
  font-weight: 700;
}

.modal-close {
  background: transparent;
  border: none;
  font-size: 20px;
  color: var(--text-gray);
  cursor: pointer;
  padding: 0;
  width: 28px;
  height: 28px;
}

.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text-dark);
}

.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 12px;
  font-family: inherit;
}

.form-group textarea {
  min-height: 120px;
  resize: vertical;
}

.tags-input-container {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  padding: 8px;
  border: 1px solid var(--border);
  border-radius: 8px;
  min-height: 42px;
}

.tag-item {
  background: var(--primary);
  color: white;
  padding: 3px 7px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
}

.tag-remove {
  background: transparent;
  border: none;
  color: white;
  cursor: pointer;
  padding: 0;
  font-size: 14px;
}

.tags-input {
  border: none;
  outline: none;
  flex: 1;
  min-width: 100px;
  font-size: 12px;
}

.modal-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 24px;
}

.modal-actions button {
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.modal-actions .btn-cancel {
  background: var(--bg-light);
  color: var(--text-dark);
}

.modal-actions .btn-cancel:hover {
  background: var(--border);
}

.modal-actions .btn-save {
  background: var(--primary);
  color: white;
}

.modal-actions .btn-save:hover {
  background: var(--primary-dark);
}

/* Drag & Drop Styles */
.card.dragging {
  opacity: 0.5;
  cursor: move;
}

.card.drag-over {
  border: 2px dashed var(--primary);
  background: rgba(16, 185, 129, 0.05);
}

.drag-handle {
  cursor: grab;
  color: var(--text-gray);
  margin-right: 8px;
  font-size: 12px;
}

.drag-handle:active {
  cursor: grabbing;
}

.drop-zone {
  border: 2px dashed var(--primary);
  background: rgba(16, 185, 129, 0.05);
  padding: 20px;
  text-align: center;
  color: var(--text-gray);
  border-radius: 10px;
  margin: 16px 0;
  display: none;
}

.drop-zone.active {
  display: block;
}

</style>
</head>
<body>

<div class="app-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h1><i class="fas fa-bolt"></i> Energy Agent</h1>
      <div class="version">v1_GR_Stable</div>
    </div>

    <div class="sidebar-nav">
      <button class="nav-button active" data-tab="dashboard">
        <i class="fas fa-home"></i>
        <span>Dashboard</span>
      </button>
      <button class="nav-button" data-tab="news">
        <i class="fas fa-newspaper"></i>
        <span>ÎÎ­Î±</span>
      </button>
      <button class="nav-button" data-tab="saved">
        <i class="fas fa-star"></i>
        <span>Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ¬</span>
      </button>
      <button class="nav-button" data-tab="prompt">
        <i class="fas fa-robot"></i>
        <span>Agent Prompt</span>
      </button>
      <button class="nav-button" data-tab="sources">
        <i class="fas fa-rss"></i>
        <span>Î Î·Î³Î­Ï‚</span>
      </button>
      <button class="nav-button" data-tab="notes">
        <i class="fas fa-sticky-note"></i>
        <span>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</span>
      </button>
    </div>

    <div class="sidebar-footer">
      <div class="ai-usage">
        <div class="ai-usage-label"><i class="fas fa-brain"></i> AI Usage Today</div>
        <div class="ai-usage-bar">
          <div class="ai-usage-fill" id="aiUsageFill" style="width: 0%"></div>
        </div>
        <div class="ai-usage-text" id="aiUsageText">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</div>
      </div>

      <div class="ai-toggle-container">
        <div class="ai-toggle-header">
          <div class="ai-toggle-label">
            <i class="fas fa-magic"></i>
            AI Search
          </div>
          <div class="toggle-switch" id="aiSearchToggle">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="ai-toggle-status" id="aiSearchStatus">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="content-header">
      <h2 id="pageTitle">Dashboard</h2>
      <p id="pageSubtitle">Î•Ï€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· ÎµÎ½ÎµÏÎ³ÎµÎ¹Î±ÎºÏÎ½ ÎµÎ¹Î´Î®ÏƒÎµÏ‰Î½ ÎºÎ±Î¹ Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î¬Ï„Ï‰Î½</p>
    </div>

    <div class="content-body" id="content">
      <!-- Content loaded dynamically -->
    </div>
  </div>
</div>

<script>
const API_BASE = 'http://localhost:8000';
let currentTab = 'dashboard';
let newsData = [];
let savedData = [];
let sourcesData = [];

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  initNavigation();
  loadTab('dashboard');
  loadAIUsage();
  initAISearchToggle();

  // Refresh AI usage every 30 seconds
  setInterval(loadAIUsage, 30000);
});

// Navigation
function initNavigation() {
  document.querySelectorAll('.nav-button').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.dataset.tab;
      document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      loadTab(tab);
    });
  });
}

async function loadTab(tab) {
  currentTab = tab;
  const content = document.getElementById('content');

  const titles = {
    dashboard: { title: 'Dashboard', subtitle: 'Î•Ï€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· ÎµÎ½ÎµÏÎ³ÎµÎ¹Î±ÎºÏÎ½ ÎµÎ¹Î´Î®ÏƒÎµÏ‰Î½ ÎºÎ±Î¹ Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î¬Ï„Ï‰Î½' },
    news: { title: 'ÎÎ­Î±', subtitle: 'ÎŒÎ»Î± Ï„Î± Ï€ÏÏŒÏƒÏ†Î±Ï„Î± Î¬ÏÎ¸ÏÎ± Î±Ï€ÏŒ Ï„Î¹Ï‚ Ï€Î·Î³Î­Ï‚ ÏƒÎ±Ï‚' },
    saved: { title: 'Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ¬', subtitle: 'Î†ÏÎ¸ÏÎ± Ï€Î¿Ï… Î­Ï‡ÎµÏ„Îµ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹ Ï‰Ï‚ ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÎ¬' },
    prompt: { title: 'Agent Prompt', subtitle: 'Î”ÏÏƒÏ„Îµ ÎµÎ½Ï„Î¿Î»Î­Ï‚ ÏƒÏ„Î¿Î½ Energy Agent' },
    sources: { title: 'Î Î·Î³Î­Ï‚', subtitle: 'Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï€Î·Î³ÏÎ½ ÎµÎ¹Î´Î®ÏƒÎµÏ‰Î½' },
    notes: { title: 'Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚', subtitle: 'Î¤Î¿ ÏƒÎ·Î¼ÎµÎ¹Ï‰Î¼Î±Ï„Î¬ÏÎ¹ÏŒ ÏƒÎ±Ï‚' }
  };

  document.getElementById('pageTitle').textContent = titles[tab].title;
  document.getElementById('pageSubtitle').textContent = titles[tab].subtitle;

  content.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</p></div>';

  try {
    switch(tab) {
      case 'dashboard':
        await loadDashboard();
        break;
      case 'news':
        await loadNews();
        break;
      case 'saved':
        await loadSaved();
        break;
      case 'prompt':
        loadPromptUI();
        break;
      case 'sources':
        await loadSources();
        break;
      case 'notes':
        await loadNotes();
        break;
    }
  } catch (error) {
    content.innerHTML = `<div class="empty-state">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>Î£Ï†Î¬Î»Î¼Î± Î¦ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚</h3>
      <p>${error.message}</p>
    </div>`;
  }
}

// Dashboard
async function loadDashboard() {
  const [newsRes, savedRes, sourcesRes] = await Promise.all([
    fetch(`${API_BASE}/news`),
    fetch(`${API_BASE}/saved`),
    fetch(`${API_BASE}/sources`)
  ]);

  const newsData = await newsRes.json();
  const savedData = await savedRes.json();
  const sourcesData = await sourcesRes.json();

  const news = newsData.news || [];
  const saved = savedData.news || [];
  const sources = sourcesData.sources || [];

  // Count by topic
  const topicCounts = {};
  news.forEach(item => {
    const topic = item.topic || 'Î†Î»Î»Î¿';
    topicCounts[topic] = (topicCounts[topic] || 0) + 1;
  });

  const content = document.getElementById('content');
  content.innerHTML = `
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">${news.length}</div>
        <div class="stat-label"><i class="fas fa-newspaper"></i> Î£ÏÎ½Î¿Î»Î¿ ÎÎ­Ï‰Î½</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${saved.length}</div>
        <div class="stat-label"><i class="fas fa-star"></i> Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ¬</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${sources.length}</div>
        <div class="stat-label"><i class="fas fa-rss"></i> Î•Î½ÎµÏÎ³Î­Ï‚ Î Î·Î³Î­Ï‚</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${Object.keys(topicCounts).length}</div>
        <div class="stat-label"><i class="fas fa-tags"></i> ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-bottom: 16px;"><i class="fas fa-clock"></i> Î ÏÏŒÏƒÏ†Î±Ï„Î± Î†ÏÎ¸ÏÎ±</h3>
      ${news.slice(0, 5).map(item => renderNewsCard(item)).join('')}
      ${news.length > 5 ? '<button class="btn btn-primary" onclick="loadTab(\'news\')">Î ÏÎ¿Î²Î¿Î»Î® ÎŒÎ»Ï‰Î½</button>' : ''}
    </div>
  `;
}

// News
async function loadNews() {
  const res = await fetch(`${API_BASE}/news`);
  const data = await res.json();
  newsData = data.news || [];

  renderNewsList(newsData);
}

// Saved
async function loadSaved() {
  const res = await fetch(`${API_BASE}/saved`);
  const data = await res.json();
  savedData = data.news || [];

  const content = document.getElementById('content');
  if (savedData.length === 0) {
    content.innerHTML = `<div class="empty-state">
      <i class="fas fa-star"></i>
      <h3>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÎ¬ Î¬ÏÎ¸ÏÎ±</h3>
      <p>Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„Î·Î½ ÎµÎ½Ï„Î¿Î»Î® "ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÏŒ &lt;link&gt;" Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ.</p>
    </div>`;
    return;
  }

  renderNewsList(savedData);
}

// Render news list
function renderNewsList(items) {
  const content = document.getElementById('content');

  if (items.length === 0) {
    content.innerHTML = `<div class="empty-state">
      <i class="fas fa-inbox"></i>
      <h3>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¬ÏÎ¸ÏÎ±</h3>
      <p>Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Ï€Î·Î³Î­Ï‚ Î® ÎµÎºÏ„ÎµÎ»Î­ÏƒÏ„Îµ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·.</p>
    </div>`;
    return;
  }

  // Get unique topics
  const topics = ['ÎŒÎ»Î±', ...new Set(items.map(i => i.topic).filter(Boolean))];

  content.innerHTML = `
    <div class="toolbar">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÏƒÏ„Î± Î¬ÏÎ¸ÏÎ±..." oninput="filterNews()">
      </div>
      <div class="filter-group">
        ${topics.map(t => `
          <button class="filter-btn ${t === 'ÎŒÎ»Î±' ? 'active' : ''}" onclick="filterByTopic('${t}')">${t}</button>
        `).join('')}
      </div>
    </div>
    <div id="newsList">${items.map(item => renderNewsCard(item)).join('')}</div>
  `;
}

function renderNewsCard(item) {
  const newsData = JSON.stringify(item).replace(/"/g, '&quot;');
  return `
    <div class="card"
         data-news='${newsData}'
         data-title="${item.title.toLowerCase()}"
         data-topic="${item.topic || ''}">
      <div class="card-title">
        <a href="${item.url}" target="_blank">${item.title}</a>
      </div>
      <div class="card-meta">
        <span><i class="far fa-clock"></i> ${formatDate(item.date)}</span>
        ${item.topic ? `<span class="badge">${item.topic}</span>` : ''}
        ${item.saved ? '<span><i class="fas fa-star" style="color: gold;"></i> Î£Î·Î¼Î±Î½Ï„Î¹ÎºÏŒ</span>' : ''}
      </div>
      ${item.summary ? `<div class="card-summary">${item.summary}</div>` : ''}
      <div class="card-actions">
        <button class="btn btn-small" onclick='addNewsToNotes(${newsData})'>
          <i class="fas fa-plus"></i> Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î¹Ï‚ Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚
        </button>
      </div>
    </div>
  `;
}

function filterNews() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  const cards = document.querySelectorAll('#newsList .card');

  cards.forEach(card => {
    const title = card.dataset.title;
    card.style.display = title.includes(query) ? 'block' : 'none';
  });
}

function filterByTopic(topic) {
  document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');

  const cards = document.querySelectorAll('#newsList .card');
  cards.forEach(card => {
    if (topic === 'ÎŒÎ»Î±' || card.dataset.topic === topic) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
}

// Prompt UI
function loadPromptUI() {
  const content = document.getElementById('content');
  content.innerHTML = `
    <!-- Analytics Dashboard -->
    <div class="card">
      <h3 style="margin-bottom: 16px;"><i class="fas fa-chart-line"></i> AI Analytics</h3>
      <div id="analyticsContainer">
        <div class="loading"><i class="fas fa-spinner"></i><p>Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Î½Î±Î»Ï…Ï„Î¹ÎºÏÎ½...</p></div>
      </div>
    </div>

    <!-- Conversation History -->
    <div class="card">
      <h3 style="margin-bottom: 16px;"><i class="fas fa-history"></i> Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î£Ï…Î¶Î·Ï„Î®ÏƒÎµÏ‰Î½</h3>
      <div id="conversationHistory">
        <div class="loading"><i class="fas fa-spinner"></i><p>Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÎ¿Ï...</p></div>
      </div>
    </div>

    <!-- Prompt Input -->
    <div class="card">
      <div class="form-group">
        <label class="form-label"><i class="fas fa-robot"></i> Î•Î½Ï„Î¿Î»Î® Ï€ÏÎ¿Ï‚ Agent</label>
        <textarea class="form-textarea" id="promptInput" placeholder="Î Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î±:
â€¢ ÏˆÎ¬Î¾Îµ Ï†Ï‰Ï„Î¿Î²Î¿Î»Ï„Î±ÏŠÎºÎ¬
â€¢ Ï€ÏÏŒÏƒÎ¸ÎµÏƒÎµ Ï€Î·Î³Î® https://example.com/feed
â€¢ Î´ÎµÎ¯Î¾Îµ Ï„Î¹Ï‚ Ï€Î·Î³Î­Ï‚
â€¢ Ï†Ï„Î¹Î¬Î¾Îµ Ï†Î¬ÎºÎµÎ»Î¿ Î‘Î½Ï„Î»Î¯ÎµÏ‚
â€¢ Î²Î¬Î»Îµ ÏƒÏ„Î¿ Î·Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿ 15/11/2025
â€¢ Î²Î¿Î®Î¸ÎµÎ¹Î±"></textarea>
      </div>
      <button class="btn btn-primary" onclick="sendPrompt()">
        <i class="fas fa-paper-plane"></i> Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®
      </button>
    </div>

    <div id="replyContainer"></div>

    <!-- Manual Scraping Controls -->
    <div class="card" style="margin-top: 24px;">
      <h3 style="margin-bottom: 12px;"><i class="fas fa-cog"></i> Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ & Î•ÏÎ³Î±Î»ÎµÎ¯Î±</h3>

      <!-- Smart Scraping Button -->
      <div style="margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="smartScrape()" style="margin-right: 12px;">
          <i class="fas fa-brain"></i> Smart Scraping (AI)
        </button>
        <button class="btn btn-secondary" onclick="manualScrape()">
          <i class="fas fa-sync-alt"></i> Manual Scraping (RSS)
        </button>
        <p style="color: var(--text-gray); margin-top: 8px; font-size: 14px;">
          <i class="fas fa-info-circle"></i> <strong>Smart Scraping:</strong> Î¨Î¬Ï‡Î½ÎµÎ¹ ÏƒÏ„Î¿ web Î¼Îµ AI Î³Î¹Î± 5 topics (Î¦Ï‰Ï„Î¿Î²Î¿Î»Ï„Î±ÏŠÎºÎ¬, Î‘Î½Ï„Î»Î¯ÎµÏ‚, ÎÎ¿Î¼Î¿Î¸ÎµÏƒÎ¯Î±, Î•Ï€Î¹Î´Î¿Ï„Î®ÏƒÎµÎ¹Ï‚, ÎœÏ€Î±Ï„Î±ÏÎ¯ÎµÏ‚)
        </p>
        <p style="color: var(--text-gray); margin-top: 4px; font-size: 14px;">
          <i class="fas fa-exclamation-triangle"></i> <strong>ÎšÏŒÏƒÏ„Î¿Ï‚:</strong> ~$0.06 Î³Î¹Î± Smart Scraping, Î¼Î¹ÎºÏÏŒÏ„ÎµÏÎ¿ Î³Î¹Î± Manual Scraping
        </p>
      </div>
      <div id="scrapeResult"></div>
    </div>

    <div class="card" style="margin-top: 24px;">
      <h3 style="margin-bottom: 12px;"><i class="fas fa-info-circle"></i> Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼ÎµÏ‚ Î•Î½Ï„Î¿Î»Î­Ï‚</h3>
      <ul style="line-height: 2; color: var(--text-gray);">
        <li><code>ÏˆÎ¬Î¾Îµ &lt;ÏŒÏÎ¿Ï‚&gt;</code> - Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÏƒÏ‡ÎµÏ„Î¹ÎºÏÎ½ Î±Ï€Î¿Ï„ÎµÎ»ÎµÏƒÎ¼Î¬Ï„Ï‰Î½</li>
        <li><code>Ï€ÏÏŒÏƒÎ¸ÎµÏƒÎµ Ï€Î·Î³Î® &lt;url&gt;</code> - Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î½Î­Î±Ï‚ Ï€Î·Î³Î®Ï‚</li>
        <li><code>Î´ÎµÎ¯Î¾Îµ Ï„Î¹Ï‚ Ï€Î·Î³Î­Ï‚</code> - Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Ï€Î·Î³ÏÎ½</li>
        <li><code>Ï†Ï„Î¹Î¬Î¾Îµ Ï†Î¬ÎºÎµÎ»Î¿ &lt;ÏŒÎ½Î¿Î¼Î±&gt;</code> - Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î½Î­Î¿Ï… Ï†Î±ÎºÎ­Î»Î¿Ï…</li>
        <li><code>Î²Î¬Î»Îµ ÏƒÏ„Î¿ Î·Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿ Î—Î—/ÎœÎœ/Î•Î•Î•Î•</code> - Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· event ÏƒÏ„Î¿ calendar</li>
        <li><code>ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÏŒ &lt;link&gt;</code> - Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ· link Ï‰Ï‚ ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÏŒ</li>
        <li><code>Î²Î¿Î®Î¸ÎµÎ¹Î±</code> - Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î²Î¿Î®Î¸ÎµÎ¹Î±Ï‚</li>
      </ul>
    </div>
  `;

  // Load analytics and history
  loadAnalytics();
  loadConversationHistory();
}

async function sendPrompt() {
  const input = document.getElementById('promptInput');
  const prompt = input.value.trim();

  if (!prompt) {
    alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Î¼Î¹Î± ÎµÎ½Ï„Î¿Î»Î®');
    return;
  }

  const replyContainer = document.getElementById('replyContainer');
  replyContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±...</p></div>';

  try {
    const res = await fetch(`${API_BASE}/prompt`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });

    const data = await res.json();

    replyContainer.innerHTML = `
      <div class="reply-box">
        <span class="reply-box-label"><i class="fas fa-robot"></i> Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· Agent</span>
        <div class="reply-box-content">${data.reply}</div>
      </div>
    `;

    // Clear input
    input.value = '';
  } catch (error) {
    replyContainer.innerHTML = `<div class="empty-state">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>Î£Ï†Î¬Î»Î¼Î±</h3>
      <p>${error.message}</p>
    </div>`;
  }
}

// Sources
async function loadSources() {
  const res = await fetch(`${API_BASE}/sources`);
  const data = await res.json();
  sourcesData = data.sources || [];

  const content = document.getElementById('content');
  content.innerHTML = `
    <div class="card">
      <h3 style="margin-bottom: 16px;"><i class="fas fa-plus-circle"></i> Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎÎ­Î±Ï‚ Î Î·Î³Î®Ï‚</h3>
      <div class="form-group">
        <label class="form-label">URL Î Î·Î³Î®Ï‚</label>
        <input type="url" class="form-input" id="newSourceUrl" placeholder="https://example.com/feed">
      </div>
      <button class="btn btn-primary" onclick="addSource()">
        <i class="fas fa-plus"></i> Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·
      </button>
    </div>

    <div class="card">
      <h3 style="margin-bottom: 16px;"><i class="fas fa-list"></i> Î¥Ï€Î¬ÏÏ‡Î¿Ï…ÏƒÎµÏ‚ Î Î·Î³Î­Ï‚ (${sourcesData.length})</h3>
      ${sourcesData.length === 0 ?
        '<p style="color: var(--text-gray);">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€Î·Î³Î­Ï‚. Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Î¼Î¯Î± Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰.</p>' :
        sourcesData.map(s => `
          <div class="source-item">
            <div class="source-info">
              <div class="source-url">${s.url}</div>
              <div class="source-type"><i class="fas fa-tag"></i> ${s.type || 'Unknown'}</div>
            </div>
            <button class="btn btn-secondary btn-small" onclick="removeSource('${s.url}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `).join('')
      }
    </div>
  `;
}

async function addSource() {
  const input = document.getElementById('newSourceUrl');
  const url = input.value.trim();

  if (!url) {
    alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Î­Î½Î± URL');
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/sources/add`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    });

    const data = await res.json();
    alert(data.result);

    // Reload sources
    await loadSources();
  } catch (error) {
    alert('Î£Ï†Î¬Î»Î¼Î±: ' + error.message);
  }
}

async function removeSource(url) {
  if (!confirm('Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î±Ï†Î±Î¹ÏÎ­ÏƒÎµÏ„Îµ Î±Ï…Ï„Î® Ï„Î·Î½ Ï€Î·Î³Î®;')) {
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/sources/remove`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    });

    const data = await res.json();
    alert(data.result);

    // Reload sources
    await loadSources();
  } catch (error) {
    alert('Î£Ï†Î¬Î»Î¼Î±: ' + error.message);
  }
}

// AI Usage
async function loadAIUsage() {
  try {
    const res = await fetch(`${API_BASE}/api-usage`);
    const data = await res.json();

    const percentage = (data.used_minutes / data.max_daily_minutes) * 100;

    document.getElementById('aiUsageFill').style.width = `${Math.min(percentage, 100)}%`;
    document.getElementById('aiUsageText').textContent =
      `${data.used_minutes.toFixed(1)} / ${data.max_daily_minutes} Î»ÎµÏ€Ï„Î¬`;
  } catch (error) {
    console.error('Failed to load AI usage:', error);
    document.getElementById('aiUsageText').textContent = 'N/A';
  }
}

// AI Search Toggle
async function initAISearchToggle() {
  const toggle = document.getElementById('aiSearchToggle');
  const status = document.getElementById('aiSearchStatus');

  try {
    // Load current status
    const res = await fetch(`${API_BASE}/search/status`);
    const data = await res.json();

    if (data.enabled) {
      toggle.classList.add('active');
      status.textContent = 'Î•Î½ÎµÏÎ³ÏŒ';
    } else {
      status.textContent = 'Î‘Î½ÎµÎ½ÎµÏÎ³ÏŒ';
    }
  } catch (error) {
    console.error('Failed to load AI search status:', error);
    status.textContent = 'Î£Ï†Î¬Î»Î¼Î±';
  }

  // Toggle click handler
  toggle.addEventListener('click', async () => {
    const isActive = toggle.classList.contains('active');
    const newState = !isActive;

    try {
      status.textContent = 'Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ·...';

      // Call backend to update .env
      const res = await fetch(`${API_BASE}/search/toggle`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled: newState })
      });

      const data = await res.json();

      if (data.success) {
        if (newState) {
          toggle.classList.add('active');
          status.textContent = 'Î•Î½ÎµÏÎ³ÏŒ';
        } else {
          toggle.classList.remove('active');
          status.textContent = 'Î‘Î½ÎµÎ½ÎµÏÎ³ÏŒ';
        }

        // Show success message
        alert(data.message || 'Î— ÏÏÎ¸Î¼Î¹ÏƒÎ· ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!');
      } else {
        status.textContent = 'Î£Ï†Î¬Î»Î¼Î±';
        alert('Î£Ï†Î¬Î»Î¼Î±: ' + (data.error || 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·Ï‚'));
      }
    } catch (error) {
      console.error('Failed to toggle AI search:', error);
      status.textContent = 'Î£Ï†Î¬Î»Î¼Î±';
      alert('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·: ' + error.message);
    }
  });
}

// Notes System
let currentNoteFilter = { category: null, tag: null, pinned: false };
let allNotes = [];
let allCategories = [];
let allTags = [];
let editingNoteId = null;

async function loadNotes() {
  const content = document.getElementById('content');

  try {
    // Fetch notes data
    const [notesRes, categoriesRes, tagsRes] = await Promise.all([
      fetch(`${API_BASE}/notes`),
      fetch(`${API_BASE}/notes/categories`),
      fetch(`${API_BASE}/notes/tags`)
    ]);

    const notesData = await notesRes.json();
    const categoriesData = await categoriesRes.json();
    const tagsData = await tagsRes.json();

    allNotes = notesData.notes || [];
    allCategories = categoriesData.categories || [];
    allTags = tagsData.tags || [];

    renderNotesUI();
  } catch (error) {
    content.innerHTML = `<div class="empty-state">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>Î£Ï†Î¬Î»Î¼Î±</h3>
      <p>Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Ï‰Î½ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÏ‰Î½</p>
    </div>`;
  }
}

function renderNotesUI() {
  const content = document.getElementById('content');

  // Filter notes
  let filteredNotes = allNotes;
  if (currentNoteFilter.category) {
    filteredNotes = filteredNotes.filter(n => n.category === currentNoteFilter.category);
  }
  if (currentNoteFilter.tag) {
    filteredNotes = filteredNotes.filter(n => n.tags.includes(currentNoteFilter.tag));
  }
  if (currentNoteFilter.pinned) {
    filteredNotes = filteredNotes.filter(n => n.pinned);
  }

  const notesHTML = filteredNotes.length > 0
    ? filteredNotes.map(note => `
        <div class="note-card ${note.pinned ? 'pinned' : ''}">
          <div class="note-header">
            <div class="note-title">${escapeHtml(note.title)}</div>
            <div class="note-actions">
              <button class="note-action-btn ${note.pinned ? 'pinned' : ''}" onclick="togglePinNote(${note.id})" title="${note.pinned ? 'ÎÎµÎºÎ±ÏÏ†Î¯Ï„ÏƒÏ‰Î¼Î±' : 'ÎšÎ±ÏÏ†Î¯Ï„ÏƒÏ‰Î¼Î±'}">
                <i class="fas fa-thumbtack"></i>
              </button>
              <button class="note-action-btn" onclick="editNote(${note.id})" title="Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±">
                <i class="fas fa-edit"></i>
              </button>
              <button class="note-action-btn" onclick="deleteNote(${note.id})" title="Î”Î¹Î±Î³ÏÎ±Ï†Î®">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          ${note.content ? `<div class="note-content">${escapeHtml(note.content)}</div>` : ''}
          <div class="note-meta">
            ${note.category ? `<span class="note-category">${escapeHtml(note.category)}</span>` : ''}
            ${note.tags.map(tag => `<span class="note-tag">#${escapeHtml(tag)}</span>`).join('')}
            <span class="note-date">${formatDate(note.updated_at)}</span>
          </div>
        </div>
      `).join('')
    : `<div class="empty-state">
        <i class="fas fa-sticky-note"></i>
        <h3>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</h3>
        <p>Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ Ï„Î· Ï€ÏÏÏ„Î· ÏƒÎ¿Ï… ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·!</p>
      </div>`;

  content.innerHTML = `
    <div class="notes-toolbar">
      <div class="notes-filters">
        <select class="filter-select" id="categoryFilter" onchange="filterNotes()">
          <option value="">ÎŒÎ»ÎµÏ‚ Î¿Î¹ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</option>
          ${allCategories.map(cat => `<option value="${cat}" ${currentNoteFilter.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
        </select>
        <select class="filter-select" id="tagFilter" onchange="filterNotes()">
          <option value="">ÎŒÎ»Î± Ï„Î± tags</option>
          ${allTags.map(tag => `<option value="${tag}" ${currentNoteFilter.tag === tag ? 'selected' : ''}>#${tag}</option>`).join('')}
        </select>
        <label style="display: flex; align-items: center; gap: 8px; padding: 8px;">
          <input type="checkbox" id="pinnedFilter" ${currentNoteFilter.pinned ? 'checked' : ''} onchange="filterNotes()" />
          <span>ÎœÏŒÎ½Î¿ ÎºÎ±ÏÏ†Î¹Ï„ÏƒÏ‰Î¼Î­Î½Î±</span>
        </label>
      </div>
      <button class="btn btn-primary" onclick="openNoteEditor()">
        <i class="fas fa-plus"></i> ÎÎ­Î± Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·
      </button>
    </div>
    <div class="notes-list">
      ${notesHTML}
    </div>
  `;
}

function filterNotes() {
  const categoryFilter = document.getElementById('categoryFilter');
  const tagFilter = document.getElementById('tagFilter');
  const pinnedFilter = document.getElementById('pinnedFilter');

  currentNoteFilter = {
    category: categoryFilter.value || null,
    tag: tagFilter.value || null,
    pinned: pinnedFilter.checked
  };

  renderNotesUI();
}

function openNoteEditor(noteId = null) {
  editingNoteId = noteId;
  const note = noteId ? allNotes.find(n => n.id === noteId) : null;

  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.id = 'noteEditorModal';

  const currentTags = note ? note.tags : [];

  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3>${noteId ? 'Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·Ï‚' : 'ÎÎ­Î± Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·'}</h3>
        <button class="modal-close" onclick="closeNoteEditor()">&times;</button>
      </div>
      <div class="form-group">
        <label>Î¤Î¯Ï„Î»Î¿Ï‚ *</label>
        <input type="text" id="noteTitle" value="${note ? escapeHtml(note.title) : ''}" placeholder="Î¤Î¯Ï„Î»Î¿Ï‚ ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·Ï‚" />
      </div>
      <div class="form-group">
        <label>Î ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿</label>
        <textarea id="noteContent" placeholder="Î“ÏÎ¬ÏˆÎµ Ï„Î¹Ï‚ ÏƒÎºÎ­ÏˆÎµÎ¹Ï‚ ÏƒÎ¿Ï…...">${note ? escapeHtml(note.content) : ''}</textarea>
      </div>
      <div class="form-group">
        <label>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</label>
        <input type="text" id="noteCategory" value="${note ? escapeHtml(note.category) : ''}" list="categoriesList" placeholder="Ï€.Ï‡. ÎˆÏÎ³Î±, Î™Î´Î­ÎµÏ‚" />
        <datalist id="categoriesList">
          ${allCategories.map(cat => `<option value="${cat}">`).join('')}
        </datalist>
      </div>
      <div class="form-group">
        <label>Tags</label>
        <div class="tags-input-container" id="tagsContainer">
          ${currentTags.map(tag => `
            <span class="tag-item">
              ${escapeHtml(tag)}
              <button class="tag-remove" onclick="removeTag('${escapeHtml(tag)}')">&times;</button>
            </span>
          `).join('')}
          <input type="text" class="tags-input" id="tagsInput" placeholder="Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ tag..." onkeydown="handleTagInput(event)" />
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeNoteEditor()">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
        <button class="btn-save" onclick="saveNote()">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function closeNoteEditor() {
  const modal = document.getElementById('noteEditorModal');
  if (modal) {
    modal.remove();
  }
  editingNoteId = null;
}

function handleTagInput(event) {
  if (event.key === 'Enter' || event.key === ',') {
    event.preventDefault();
    const input = event.target;
    const tag = input.value.trim().replace(/^#/, '');
    if (tag) {
      addTag(tag);
      input.value = '';
    }
  }
}

function addTag(tag) {
  const container = document.getElementById('tagsContainer');
  const input = document.getElementById('tagsInput');

  // Check if tag already exists
  const existingTags = Array.from(container.querySelectorAll('.tag-item')).map(el => el.textContent.trim().replace('Ã—', ''));
  if (existingTags.includes(tag)) return;

  const tagEl = document.createElement('span');
  tagEl.className = 'tag-item';
  tagEl.innerHTML = `
    ${escapeHtml(tag)}
    <button class="tag-remove" onclick="removeTag('${escapeHtml(tag)}')">&times;</button>
  `;
  container.insertBefore(tagEl, input);
}

function removeTag(tag) {
  const container = document.getElementById('tagsContainer');
  const tags = container.querySelectorAll('.tag-item');
  tags.forEach(tagEl => {
    if (tagEl.textContent.trim().replace('Ã—', '') === tag) {
      tagEl.remove();
    }
  });
}

async function saveNote() {
  const title = document.getElementById('noteTitle').value.trim();
  const content = document.getElementById('noteContent').value.trim();
  const category = document.getElementById('noteCategory').value.trim();
  const tagsContainer = document.getElementById('tagsContainer');
  const tags = Array.from(tagsContainer.querySelectorAll('.tag-item')).map(el =>
    el.textContent.trim().replace('Ã—', '')
  );

  if (!title) {
    alert('ÎŸ Ï„Î¯Ï„Î»Î¿Ï‚ ÎµÎ¯Î½Î±Î¹ Ï…Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÏŒÏ‚');
    return;
  }

  try {
    const endpoint = editingNoteId ? '/notes/update' : '/notes/add';
    const payload = { title, content, category, tags };
    if (editingNoteId) {
      payload.id = editingNoteId;
    }

    const res = await fetch(`${API_BASE}${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.error) {
      alert('Î£Ï†Î¬Î»Î¼Î±: ' + data.error);
      return;
    }

    closeNoteEditor();
    await loadNotes();
  } catch (error) {
    alert('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·: ' + error.message);
  }
}

async function togglePinNote(noteId) {
  try {
    const res = await fetch(`${API_BASE}/notes/toggle-pin`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: noteId })
    });

    const data = await res.json();
    if (data.success) {
      await loadNotes();
    }
  } catch (error) {
    console.error('Failed to toggle pin:', error);
  }
}

async function deleteNote(noteId) {
  if (!confirm('Î•Î¯ÏƒÎ±Î¹ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Ï‚ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ Î±Ï…Ï„Î® Ï„Î· ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·;')) {
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/notes/delete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: noteId })
    });

    const data = await res.json();
    if (data.success) {
      await loadNotes();
    }
  } catch (error) {
    alert('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®: ' + error.message);
  }
}

function editNote(noteId) {
  openNoteEditor(noteId);
}

// Utilities
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  try {
    const date = new Date(dateStr);
    return date.toLocaleString('el-GR', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch {
    return dateStr;
  }
}

// ===========================
// Add News to Notes Functionality
// ===========================

async function addNewsToNotes(newsItem) {
  try {
    // Show loading message
    const loadingMsg = 'Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·Ï‚ Î¼Îµ AI Ï€ÎµÏÎ¯Î»Î·ÏˆÎ·...';
    if (!confirm(loadingMsg + '\n\nÎ˜Î­Î»ÎµÏ„Îµ Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÏ„Îµ;')) {
      return;
    }

    // Request AI summary from backend
    const summaryRes = await fetch(`${API_BASE}/notes/generate-summary`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title: newsItem.title,
        url: newsItem.url,
        summary: newsItem.summary || '',
        topic: newsItem.topic || ''
      })
    });

    const summaryData = await summaryRes.json();

    // Create note content with AI summary
    let content = `Î Î·Î³Î®: ${newsItem.url}\n\n`;

    if (summaryData.ai_summary) {
      content += `ğŸ“ AI Î ÎµÏÎ¯Î»Î·ÏˆÎ·:\n${summaryData.ai_summary}\n\n`;
    }

    if (newsItem.summary) {
      content += `Î‘ÏÏ‡Î¹ÎºÎ® Î ÎµÏÎ¯Î»Î·ÏˆÎ·:\n${newsItem.summary}`;
    }

    const title = newsItem.title;
    const category = newsItem.topic || 'ÎÎ­Î±';
    const tags = ['Î±Ï€ÏŒ-Î½Î­Î±', newsItem.topic].filter(Boolean);

    // Save the note
    const res = await fetch(`${API_BASE}/notes/add`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title: title,
        content: content,
        category: category,
        tags: tags
      })
    });

    const data = await res.json();

    if (data.error) {
      alert('Î£Ï†Î¬Î»Î¼Î±: ' + data.error);
    } else {
      alert('Î— ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ· Î¼Îµ AI Ï€ÎµÏÎ¯Î»Î·ÏˆÎ· Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!');
    }
  } catch (error) {
    alert('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·Ï‚: ' + error.message);
  }
}

// ===========================
// Conversation & Analytics Functions
// ===========================

let lastConversationId = null;

async function loadAnalytics() {
  const container = document.getElementById('analyticsContainer');
  try {
    const res = await fetch(`${API_BASE}/conversations/analytics`);
    const data = await res.json();

    if (data.error) {
      container.innerHTML = `<p style="color: var(--text-gray);">Î£Ï†Î¬Î»Î¼Î±: ${data.error}</p>`;
      return;
    }

    const { total_conversations, total_api_calls, total_tokens, total_cost_usd, avg_latency_ms, rating_distribution } = data;

    container.innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div style="text-align: center;">
          <div style="font-size: 32px; font-weight: bold; color: var(--primary);">${total_conversations || 0}</div>
          <div style="color: var(--text-gray); margin-top: 4px;">Î£Ï…Î¶Î·Ï„Î®ÏƒÎµÎ¹Ï‚</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 32px; font-weight: bold; color: var(--primary);">${total_api_calls || 0}</div>
          <div style="color: var(--text-gray); margin-top: 4px;">AI ÎšÎ»Î®ÏƒÎµÎ¹Ï‚</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 32px; font-weight: bold; color: var(--primary);">${(total_tokens || 0).toLocaleString()}</div>
          <div style="color: var(--text-gray); margin-top: 4px;">Tokens</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 32px; font-weight: bold; color: var(--primary);">$${(total_cost_usd || 0).toFixed(4)}</div>
          <div style="color: var(--text-gray); margin-top: 4px;">ÎšÏŒÏƒÏ„Î¿Ï‚</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 32px; font-weight: bold; color: var(--primary);">${avg_latency_ms || 0}ms</div>
          <div style="color: var(--text-gray); margin-top: 4px;">ÎœÎ­ÏƒÎ· ÎšÎ±Î¸Ï…ÏƒÏ„Î­ÏÎ·ÏƒÎ·</div>
        </div>
      </div>
      ${rating_distribution && rating_distribution.length > 0 ? `
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
          <h4 style="margin-bottom: 12px;"><i class="fas fa-star"></i> ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Ratings</h4>
          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            ${rating_distribution.map(r => `
              <div style="flex: 1; min-width: 80px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold;">${r.count}</div>
                <div style="color: var(--text-gray);">${'â­'.repeat(r.rating)}</div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
    `;
  } catch (error) {
    container.innerHTML = `<p style="color: var(--text-gray);">Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚: ${error.message}</p>`;
  }
}

async function loadConversationHistory() {
  const container = document.getElementById('conversationHistory');
  try {
    const res = await fetch(`${API_BASE}/conversations/history?limit=10`);
    const data = await res.json();

    if (data.error || !data.history || data.history.length === 0) {
      container.innerHTML = `<p style="color: var(--text-gray);">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î±ÎºÏŒÎ¼Î± Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ ÏƒÏ…Î¶Î·Ï„Î®ÏƒÎµÏ‰Î½.</p>`;
      return;
    }

    let historyHTML = '<div style="max-height: 400px; overflow-y: auto;">';

    // Group by pairs (user + assistant)
    for (let i = 0; i < data.history.length; i++) {
      const msg = data.history[i];

      if (msg.role === 'user') {
        const nextMsg = i + 1 < data.history.length ? data.history[i + 1] : null;

        historyHTML += `
          <div style="margin-bottom: 20px; padding: 12px; background: var(--bg); border-radius: 8px; border-left: 3px solid var(--primary);">
            <div style="margin-bottom: 8px;">
              <strong style="color: var(--primary);"><i class="fas fa-user"></i> Î•ÏƒÏ:</strong>
              <p style="margin: 4px 0 0 0;">${msg.content}</p>
            </div>
            ${nextMsg && nextMsg.role === 'assistant' ? `
              <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                <strong style="color: var(--secondary);"><i class="fas fa-robot"></i> Agent:</strong>
                <p style="margin: 4px 0 0 0;">${nextMsg.content}</p>
              </div>
            ` : ''}
          </div>
        `;

        if (nextMsg && nextMsg.role === 'assistant') {
          i++; // Skip the assistant message since we already displayed it
        }
      }
    }

    historyHTML += '</div>';
    container.innerHTML = historyHTML;
  } catch (error) {
    container.innerHTML = `<p style="color: var(--text-gray);">Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚: ${error.message}</p>`;
  }
}

async function rateLastResponse(rating) {
  if (!lastConversationId) {
    alert('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï€ÏÏŒÏƒÏ†Î±Ï„Î· ÏƒÏ…Î¶Î®Ï„Î·ÏƒÎ· Î³Î¹Î± rating.');
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/conversations/rate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        conversation_id: lastConversationId,
        rating: rating
      })
    });

    const data = await res.json();

    if (data.success) {
      alert(`Î•Ï…Ï‡Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ¼Îµ! Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·: ${'â­'.repeat(rating)}`);
      loadAnalytics(); // Reload analytics
      loadConversationHistory(); // Reload history
    } else {
      alert('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Î¿Ï… rating.');
    }
  } catch (error) {
    alert('Î£Ï†Î¬Î»Î¼Î±: ' + error.message);
  }
}

async function smartScrape() {
  const resultDiv = document.getElementById('scrapeResult');
  resultDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Smart Scraping ÏƒÎµ ÎµÎ¾Î­Î»Î¹Î¾Î·... (Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï€Î¬ÏÎµÎ¹ 1-2 Î»ÎµÏ€Ï„Î¬)</p></div>';

  try {
    const res = await fetch(`${API_BASE}/scrape/smart`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        topics: null,  // null = ÏŒÎ»Î± Ï„Î± topics
        max_per_topic: 5
      })
    });

    const data = await res.json();

    if (data.success) {
      const topicDetails = Object.entries(data.results_by_topic || {})
        .map(([topic, count]) => `<li>${topic}: <strong>${count}</strong> Î¬ÏÎ¸ÏÎ±</li>`)
        .join('');

      resultDiv.innerHTML = `
        <div style="padding: 12px; background: var(--success-bg); border-left: 3px solid var(--success); border-radius: 4px;">
          <i class="fas fa-check-circle"></i> ${data.message}
          <ul style="margin-top: 8px; padding-left: 20px;">
            ${topicDetails}
          </ul>
        </div>
      `;

      // Reload news after scraping
      if (currentView === 'news') {
        await loadNews();
      }
    } else {
      resultDiv.innerHTML = `
        <div style="padding: 12px; background: var(--error-bg); border-left: 3px solid var(--error); border-radius: 4px;">
          <i class="fas fa-exclamation-triangle"></i> ${data.message || 'Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î¿ scraping'}
        </div>
      `;
    }
  } catch (error) {
    resultDiv.innerHTML = `
      <div style="padding: 12px; background: var(--error-bg); border-left: 3px solid var(--error); border-radius: 4px;">
        <i class="fas fa-exclamation-triangle"></i> Î£Ï†Î¬Î»Î¼Î±: ${error.message}
      </div>
    `;
  }
}

async function manualScrape() {
  const resultDiv = document.getElementById('scrapeResult');
  resultDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><p>Scraping ÏƒÎµ ÎµÎ¾Î­Î»Î¹Î¾Î·...</p></div>';

  try {
    const res = await fetch(`${API_BASE}/scrape/manual`, {
      method: 'POST'
    });

    const data = await res.json();

    if (data.success) {
      resultDiv.innerHTML = `
        <div style="padding: 12px; background: var(--success-bg); border-left: 3px solid var(--success); border-radius: 4px;">
          <i class="fas fa-check-circle"></i> ${data.message}
        </div>
      `;

      // Reload news after scraping
      if (currentView === 'news') {
        await loadNews();
      }
    } else {
      resultDiv.innerHTML = `
        <div style="padding: 12px; background: var(--error-bg); border-left: 3px solid var(--error); border-radius: 4px;">
          <i class="fas fa-exclamation-triangle"></i> ${data.message || 'Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î¿ scraping'}
        </div>
      `;
    }
  } catch (error) {
    resultDiv.innerHTML = `
      <div style="padding: 12px; background: var(--error-bg); border-left: 3px solid var(--error); border-radius: 4px;">
        <i class="fas fa-exclamation-triangle"></i> Î£Ï†Î¬Î»Î¼Î±: ${error.message}
      </div>
    `;
  }
}

</script>

</body>
</html>
